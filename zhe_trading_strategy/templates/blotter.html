{% extends "base.html" %}

{% block title %}Trading Records - Quantitative Trading Strategy Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-white">
                <h2 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Trading Records (Blotter)</h2>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="date-from" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="date-from">
                    </div>
                    <div class="col-md-3">
                        <label for="date-to" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="date-to">
                    </div>
                    <div class="col-md-3">
                        <label for="ticker-filter" class="form-label">Symbol</label>
                        <input type="text" class="form-control" id="ticker-filter" placeholder="All">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="loadTrades()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Trading Statistics -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Account Type</h5>
                                <h6 id="account-type"><span class="badge bg-warning text-dark">Paper Account</span></h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Total P&L</h5>
                                <h3 id="total-pnl">$-</h3>
                                <small id="pnl-percent">-%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Total Trades</h5>
                                <h3 id="total-trades">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Buy Orders</h5>
                                <h3 class="text-success" id="buy-orders">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Sell Orders</h5>
                                <h3 class="text-danger" id="sell-orders">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h5 class="text-muted">Total Value</h5>
                                <h3 id="total-value">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Records Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body">
                            <tr>
                                <td colspan="9" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function loadTrades() {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const tickerFilter = document.getElementById('ticker-filter').value;
        
        let url = API_BASE_URL ? `${API_BASE_URL}/api/blotter/trades` : '/api/blotter/trades';
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (tickerFilter) params.append('ticker', tickerFilter);
        if (params.toString()) url += '?' + params.toString();
        
        const tbody = document.getElementById('trades-table-body');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error === "No data available") {
                        tbody.innerHTML = 
                            '<tr><td colspan="9" class="text-center text-muted">No data available</td></tr>';
                    } else {
                        tbody.innerHTML = 
                            '<tr><td colspan="9" class="text-center text-danger">Failed to load data, please check backend service</td></tr>';
                    }
                    document.getElementById('total-trades').textContent = '0';
                    document.getElementById('buy-orders').textContent = '0';
                    document.getElementById('sell-orders').textContent = '0';
                    document.getElementById('total-value').textContent = '$0';
                    return;
                }

                if (data.trades && data.trades.length > 0) {
                    renderTradesTable(data.trades);
                    updateStats(data.trades);
                } else {
                    tbody.innerHTML = 
                        '<tr><td colspan="9" class="text-center text-muted">No data available</td></tr>';
                    document.getElementById('total-trades').textContent = '0';
                    document.getElementById('buy-orders').textContent = '0';
                    document.getElementById('sell-orders').textContent = '0';
                    document.getElementById('total-value').textContent = '$0';
                }
            })
            .catch(error => {
                console.error('Error loading trades:', error);
                tbody.innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger">Failed to load data, please check backend service</td></tr>';
                document.getElementById('total-trades').textContent = '0';
                document.getElementById('buy-orders').textContent = '0';
                document.getElementById('sell-orders').textContent = '0';
                document.getElementById('total-value').textContent = '$0';
            });
    }

    function renderTradesTable(trades) {
        const tbody = document.getElementById('trades-table-body');
        tbody.innerHTML = trades.map(trade => {
            const symbol = trade.symbol || trade.ticker;
            const side = trade.side || trade.direction;
            const qty = trade.qty || trade.quantity || 0;
            const price = trade.price || 0;
            const amount = trade.amount || trade.value || (qty * price);
            
            // P&L 信息
            const tradePnl = trade.trade_pnl || 0;
            const tradePnlPercent = trade.trade_pnl_percent || 0;
            const pnlType = trade.pnl_type || "N/A";
            const pnlClass = tradePnl >= 0 ? 'text-success' : 'text-danger';
            const pnlSign = tradePnl >= 0 ? '+' : '';
            
            // P&L 显示文本
            let pnlDisplay = '-';
            let pnlPercentDisplay = '-';
            if (pnlType !== "N/A" && (tradePnl !== 0 || tradePnlPercent !== 0)) {
                pnlDisplay = `${pnlSign}$${Math.abs(tradePnl).toFixed(2)}`;
                pnlPercentDisplay = `${pnlSign}${Math.abs(tradePnlPercent).toFixed(2)}%`;
            }
            
            return `
            <tr>
                <td>${trade.time || '-'}</td>
                <td><strong>${symbol}</strong></td>
                <td>
                    <span class="badge ${side === 'BUY' || side === 'BOT' ? 'bg-success' : 'bg-danger'}">
                        ${side}
                    </span>
                </td>
                <td>${qty.toFixed(2)}</td>
                <td>$${price > 0 ? price.toFixed(2) : '-'}</td>
                <td>$${amount > 0 ? amount.toFixed(2) : '-'}</td>
                <td class="${pnlClass}">
                    ${pnlDisplay}
                    ${pnlType !== "N/A" ? `<small class="d-block text-muted">${pnlType}</small>` : ''}
                </td>
                <td class="${pnlClass}">${pnlPercentDisplay}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(trade.status)}">
                        ${trade.status || 'FILLED'}
                    </span>
                </td>
            </tr>
        `;
        }).join('');
    }

    function updateStats(trades) {
        const total = trades.length;
        const buys = trades.filter(t => (t.side || t.direction) === 'BUY').length;
        const sells = trades.filter(t => (t.side || t.direction) === 'SELL').length;
        const totalValue = trades.reduce((sum, t) => sum + (t.amount || t.value || 0), 0);

        document.getElementById('total-trades').textContent = total;
        document.getElementById('buy-orders').textContent = buys;
        document.getElementById('sell-orders').textContent = sells;
        document.getElementById('total-value').textContent = '$' + totalValue.toFixed(2);
    }

    function getStatusBadgeClass(status) {
        const statusMap = {
            'FILLED': 'bg-success',
            'PARTIAL': 'bg-warning',
            'PENDING': 'bg-secondary',
            'CANCELLED': 'bg-danger'
        };
        return statusMap[status] || 'bg-secondary';
    }

    // Load P&L statistics
    function loadAccountStats() {
        const url = API_BASE_URL ? `${API_BASE_URL}/api/ibkr/pnl` : '/api/ibkr/pnl';
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // 支持从文件或实时连接获取的数据
                if (!data.error && (data.source === 'ibkr' || data.source === 'file')) {
                    // Display P&L statistics
                    const totalPnL = data.total_profit_loss !== undefined 
                        ? data.total_profit_loss 
                        : (data.realized_pnl || 0) + (data.unrealized_pnl || 0);
                    const pnlPercent = data.profit_loss_percent !== undefined
                        ? data.profit_loss_percent
                        : (data.net_liquidation > 0 ? (totalPnL / data.net_liquidation * 100) : 0);
                    
                    const pnlElement = document.getElementById('total-pnl');
                    const percentElement = document.getElementById('pnl-percent');
                    
                    pnlElement.textContent = `$${totalPnL >= 0 ? '+' : ''}${totalPnL.toFixed(2)}`;
                    // Use color classes for text instead of changing background
                    pnlElement.className = totalPnL >= 0 ? 'text-success' : 'text-danger';
                    
                    percentElement.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
                    percentElement.className = pnlPercent >= 0 ? 'text-success' : 'text-danger';
                } else {
                    document.getElementById('total-pnl').textContent = '$-';
                    document.getElementById('pnl-percent').textContent = '-%';
                }
            })
            .catch(error => {
                console.error('Error loading account stats:', error);
                document.getElementById('total-pnl').textContent = '$-';
                document.getElementById('pnl-percent').textContent = '-%';
            });
    }

    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadTrades();
        loadAccountStats();
    });
</script>
{% endblock %}

