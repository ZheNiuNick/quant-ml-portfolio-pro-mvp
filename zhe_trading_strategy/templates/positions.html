{% extends "base.html" %}

{% block title %}Positions Analysis - Quantitative Trading Strategy Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h2 class="mb-0"><i class="fas fa-briefcase me-2"></i>Daily Real Positions</h2>
            </div>
            <div class="card-body">
                <!-- Position Description -->
                <div class="alert alert-info mb-4">
                    <h5><i class="fas fa-info-circle me-2"></i>Position Generation Process</h5>
                    <p class="mb-0">Current positions are automatically generated through the complete quantitative trading workflow. See details below.</p>
                </div>

                <!-- Current Positions -->
                <h4 class="mb-3">Current Positions (<span id="position-date">-</span>)</h4>
                <div class="table-responsive mb-4">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Weight</th>
                                <th>Current Price</th>
                                <th>Position Value</th>
                            </tr>
                        </thead>
                        <tbody id="positions-table-body">
                            <tr>
                                <td colspan="4" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Position Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Position Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div id="position-stats">
                                    <p class="text-muted">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Position Generation Process -->
                <h4 class="mb-3"><i class="fas fa-sitemap me-2"></i>Position Generation Process</h4>
                <div id="workflow-explanation">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load current positions
    function loadCurrentPositions() {
        const tbody = document.getElementById('positions-table-body');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>';
        
        const url = API_BASE_URL ? `${API_BASE_URL}/api/positions/current` : '/api/positions/current';
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    if (data.error === "No data available") {
                        tbody.innerHTML = 
                            '<tr><td colspan="4" class="text-center text-muted">No data available</td></tr>';
                    } else {
                        tbody.innerHTML = 
                            '<tr><td colspan="4" class="text-center text-danger">' + 
                            '<i class="fas fa-exclamation-triangle me-2"></i>Failed to load data, please check backend service</td></tr>';
                    }
                    return;
                }

                if (data.date) {
                    document.getElementById('position-date').textContent = data.date;
                }
                
                // Render positions table - support both IBKR and backtest formats
                if (data.positions && data.positions.length > 0) {
                    tbody.innerHTML = data.positions.map(pos => {
                        const symbol = pos.symbol || pos.ticker || '-';
                        const quantity = pos.quantity || 0;
                        const weight = pos.weight || 0;
                        // Support multiple field names
                        const price_val = pos.price || pos.current_price || 0;
                        const value_val = pos.value || pos.market_value || 0;
                        
                        const price = price_val > 0 ? `$${price_val.toFixed(2)}` : 
                                     '<span class="text-muted">Price not available</span>';
                        const value = value_val > 0 ? `$${value_val.toFixed(2)}` : '-';
                        
                        // Weight display: prioritize weight percentage, otherwise show shares
                        let weightDisplay = '-';
                        if (weight > 0) {
                            weightDisplay = (weight * 100).toFixed(2) + '%';
                        } else if (quantity > 0) {
                            weightDisplay = quantity.toFixed(2) + ' shares';
                        }
                        
                        return `
                        <tr>
                            <td><strong>${symbol}</strong></td>
                            <td>${weightDisplay}</td>
                            <td>${price}</td>
                            <td>${value}</td>
                        </tr>
                    `;
                    }).join('');

                    // Render Position Statistics
                    renderPositionStats(data);
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading positions:', error);
                tbody.innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">' +
                    '<i class="fas fa-times-circle me-2"></i>Failed to load data, please check backend service</td></tr>';
            });
    }

    function renderPositionStats(data) {
        const statsHtml = `
            <ul class="list-unstyled">
                <li><strong>Position Date:</strong>${data.date}</li>
                <li><strong>Position Count: </strong>${data.total_stocks}  stocks</li>
                <li><strong>Average Weight: </strong>${(100 / data.total_stocks).toFixed(2)}%</li>
                <li><strong>Strategy Type:</strong>TopK Dropout (Equal Weight)</li>
            </ul>
        `;
        document.getElementById('position-stats').innerHTML = statsHtml;
    }

    // Load workflow explanation
    function loadWorkflowExplanation() {
        fetch('/api/positions/explanation')
            .then(response => response.json())
            .then(data => {
                if (data.workflow) {
                    const html = data.workflow.map((step, index) => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5>Step ${step.step}: ${step.title}</h5>
                                <p class="mb-0">${step.description}</p>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('workflow-explanation').innerHTML = html;
                }
            })
            .catch(error => console.error('Error loading explanation:', error));
    }

    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadCurrentPositions();
        loadWorkflowExplanation();
    });
</script>
{% endblock %}

